#!/bin/bash

# Пути
LISTS="/opt/zapret/lists"
FILES="/opt/zapret/files"

# Game Filter (аналог Windows логики)
if [ -f "/opt/zapret/game_filter.enabled" ]; then
    GAME_FILTER="1024-65535"
else
    GAME_FILTER="12"
fi

# Стратегия nfqws (каждый профиль на отдельной строке для читаемости)
# ВАЖНО: параметры типа fake,multisplit должны быть БЕЗ пробелов!
NFQWS_ARGS=(
    # Профиль 1: UDP 443 для общего списка (QUIC трафик)
    "--filter-udp=443"
    "--hostlist=$LISTS/list-general.txt"
    "--hostlist-exclude=$LISTS/list-exclude.txt"
    "--ipset-exclude=$LISTS/ipset-exclude.txt"
    "--dpi-desync=fake"
    "--dpi-desync-repeats=11"
    "--dpi-desync-fake-quic=$FILES/quic_initial_www_google_com.bin"
    "--new"

    # Профиль 2: Discord UDP (voice/video)
    "--filter-udp=19294-19344,50000-50100"
    "--filter-l7=discord,stun"
    "--dpi-desync=fake"
    "--dpi-desync-repeats=6"
    "--new"

    # Профиль 3: Discord TCP (альтернативные порты)
    "--filter-tcp=2053,2083,2087,2096,8443"
    "--hostlist-domains=discord.media"
    "--dpi-desync=fake,multisplit"
    "--dpi-desync-split-seqovl=654"
    "--dpi-desync-split-pos=1"
    "--dpi-desync-fooling=ts"
    "--dpi-desync-repeats=8"
    "--dpi-desync-split-seqovl-pattern=$FILES/tls_clienthello_max_ru.bin"
    "--dpi-desync-fake-tls=$FILES/tls_clienthello_max_ru.bin"
    "--new"

    # Профиль 4: YouTube/Google TCP 443 (КРИТИЧНЫЙ ДЛЯ YOUTUBE!)
    "--filter-tcp=443"
    "--hostlist=$LISTS/list-google.txt"
    "--ip-id=zero"
    "--dpi-desync=fake,multisplit"
    "--dpi-desync-split-seqovl=681"
    "--dpi-desync-split-pos=1"
    "--dpi-desync-fooling=ts"
    "--dpi-desync-repeats=8"
    "--dpi-desync-split-seqovl-pattern=$FILES/tls_clienthello_www_google_com.bin"
    "--dpi-desync-fake-tls=$FILES/tls_clienthello_www_google_com.bin"
    "--new"

    # Профиль 5: Общий список TCP 80,443
    "--filter-tcp=80,443"
    "--hostlist=$LISTS/list-general.txt"
    "--hostlist-exclude=$LISTS/list-exclude.txt"
    "--ipset-exclude=$LISTS/ipset-exclude.txt"
    "--dpi-desync=fake,multisplit"
    "--dpi-desync-split-seqovl=654"
    "--dpi-desync-split-pos=1"
    "--dpi-desync-fooling=ts"
    "--dpi-desync-repeats=8"
    "--dpi-desync-split-seqovl-pattern=$FILES/tls_clienthello_max_ru.bin"
    "--dpi-desync-fake-tls=$FILES/tls_clienthello_max_ru.bin"
    "--new"

    # Профиль 6: UDP 443 для IP списков (дубликат с ipset вместо hostlist)
    "--filter-udp=443"
    "--ipset=$LISTS/ipset-all.txt"
    "--hostlist-exclude=$LISTS/list-exclude.txt"
    "--ipset-exclude=$LISTS/ipset-exclude.txt"
    "--dpi-desync=fake"
    "--dpi-desync-repeats=11"
    "--dpi-desync-fake-quic=$FILES/quic_initial_www_google_com.bin"
    "--new"

    # Профиль 7: TCP для IP списков + Game Filter
    "--filter-tcp=80,443,$GAME_FILTER"
    "--ipset=$LISTS/ipset-all.txt"
    "--hostlist-exclude=$LISTS/list-exclude.txt"
    "--ipset-exclude=$LISTS/ipset-exclude.txt"
    "--dpi-desync=fake,multisplit"
    "--dpi-desync-split-seqovl=654"
    "--dpi-desync-split-pos=1"
    "--dpi-desync-fooling=ts"
    "--dpi-desync-repeats=8"
    "--dpi-desync-split-seqovl-pattern=$FILES/tls_clienthello_max_ru.bin"
    "--dpi-desync-fake-tls=$FILES/tls_clienthello_max_ru.bin"
    "--new"

    # Профиль 8: UDP Game Filter
    "--filter-udp=$GAME_FILTER"
    "--ipset=$LISTS/ipset-all.txt"
    "--ipset-exclude=$LISTS/ipset-exclude.txt"
    "--dpi-desync=fake"
    "--dpi-desync-autottl=2"
    "--dpi-desync-repeats=10"
    "--dpi-desync-any-protocol=1"
    "--dpi-desync-fake-unknown-udp=$FILES/quic_initial_www_google_com.bin"
    "--dpi-desync-cutoff=n2"
)
