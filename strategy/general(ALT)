#!/bin/bash

# Пути
LISTS="/opt/zapret/lists"
FILES="/opt/zapret/files"

# Game Filter (аналог Windows логики)
if [ -f "/opt/zapret/game_filter.enabled" ]; then
    GAME_FILTER="1024-65535"
else
    GAME_FILTER="12"
fi

# Стратегия nfqws (адаптация новой Windows стратегии)
# ВАЖНЫЕ ОТЛИЧИЯ winws vs nfqws:
# - winws использует --wf-tcp/--wf-udp для фильтрации на уровне WinDivert
# - nfqws получает пакеты уже отфильтрованные через nftables/iptables
# - fakedsplit в winws = fake,disorder в nfqws (или просто fake,split)
# - --dpi-desync-fake-discord и --dpi-desync-fake-stun в nfqws используются через --dpi-desync-fake-quic
# - --dpi-desync-fakedsplit-pattern в nfqws это --dpi-desync-split-pos

NFQWS_ARGS=(
    # Профиль 1: UDP 443 для общего списка (QUIC трафик)
    # winws: --filter-udp=443 + list-general.txt
    "--filter-udp=443"
    "--hostlist=$LISTS/list-general.txt"
    "--hostlist-exclude=$LISTS/list-exclude.txt"
    "--ipset-exclude=$LISTS/ipset-exclude.txt"
    "--dpi-desync=fake"
    "--dpi-desync-repeats=6"
    "--dpi-desync-fake-quic=$FILES/quic_initial_www_google_com.bin"
    "--new"

    # Профиль 2: Discord UDP (voice/video)
    # winws: --filter-udp=19294-19344,50000-50100 + discord,stun
    # В nfqws --dpi-desync-fake-discord и --dpi-desync-fake-stun не существуют
    # Используем --dpi-desync-fake-quic для всех UDP fake пакетов
    "--filter-udp=19294-19344,50000-50100"
    "--filter-l7=discord,stun"
    "--dpi-desync=fake"
    "--dpi-desync-repeats=6"
    "--dpi-desync-fake-quic=$FILES/quic_initial_www_google_com.bin"
    "--new"

    # Профиль 3: Discord TCP (альтернативные порты)
    # winws: fakedsplit -> nfqws: fake,disorder или fake,split
    # --dpi-desync-fakedsplit-pattern=0x00 -> --dpi-desync-split-pos=1 (начало пакета)
    "--filter-tcp=2053,2083,2087,2096,8443"
    "--hostlist-domains=discord.media"
    "--dpi-desync=fake,disorder"
    "--dpi-desync-split-pos=1"
    "--dpi-desync-fooling=ts"
    "--dpi-desync-repeats=6"
    "--dpi-desync-fake-tls=$FILES/tls_clienthello_www_google_com.bin"
    "--new"

    # Профиль 4: YouTube/Google TCP 443 (КРИТИЧНЫЙ!)
    # winws: fakedsplit + ip-id=zero
    # Это КЛЮЧЕВОЙ профиль для YouTube
    "--filter-tcp=443"
    "--hostlist=$LISTS/list-google.txt"
    "--ip-id=zero"
    "--dpi-desync=fake,disorder"
    "--dpi-desync-split-pos=1"
    "--dpi-desync-fooling=ts"
    "--dpi-desync-repeats=6"
    "--dpi-desync-fake-tls=$FILES/tls_clienthello_www_google_com.bin"
    "--new"

    # Профиль 5: Общий список TCP 80,443
    # winws: fakedsplit с теми же параметрами
    "--filter-tcp=80,443"
    "--hostlist=$LISTS/list-general.txt"
    "--hostlist-exclude=$LISTS/list-exclude.txt"
    "--ipset-exclude=$LISTS/ipset-exclude.txt"
    "--dpi-desync=fake,disorder"
    "--dpi-desync-split-pos=1"
    "--dpi-desync-fooling=ts"
    "--dpi-desync-repeats=6"
    "--dpi-desync-fake-tls=$FILES/tls_clienthello_www_google_com.bin"
    "--new"

    # Профиль 6: UDP 443 для IP списков
    # Дубликат профиля 1 но с ipset вместо hostlist
    "--filter-udp=443"
    "--ipset=$LISTS/ipset-all.txt"
    "--hostlist-exclude=$LISTS/list-exclude.txt"
    "--ipset-exclude=$LISTS/ipset-exclude.txt"
    "--dpi-desync=fake"
    "--dpi-desync-repeats=6"
    "--dpi-desync-fake-quic=$FILES/quic_initial_www_google_com.bin"
    "--new"

    # Профиль 7: TCP для IP списков + Game Filter
    # winws: fakedsplit для всех TCP портов
    "--filter-tcp=80,443,$GAME_FILTER"
    "--ipset=$LISTS/ipset-all.txt"
    "--hostlist-exclude=$LISTS/list-exclude.txt"
    "--ipset-exclude=$LISTS/ipset-exclude.txt"
    "--dpi-desync=fake,disorder"
    "--dpi-desync-split-pos=1"
    "--dpi-desync-fooling=ts"
    "--dpi-desync-repeats=6"
    "--dpi-desync-fake-tls=$FILES/tls_clienthello_www_google_com.bin"
    "--new"

    # Профиль 8: UDP Game Filter
    # winws: с autottl и cutoff=n3
    # ВАЖНО: cutoff=n3 означает "до 3 пакетов", в nfqws это работает так же
    "--filter-udp=$GAME_FILTER"
    "--ipset=$LISTS/ipset-all.txt"
    "--ipset-exclude=$LISTS/ipset-exclude.txt"
    "--dpi-desync=fake"
    "--dpi-desync-autottl=2"
    "--dpi-desync-repeats=12"
    "--dpi-desync-any-protocol=1"
    "--dpi-desync-fake-quic=$FILES/quic_initial_www_google_com.bin"
    "--dpi-desync-cutoff=n3"
)